<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>uextract ‚Äì UE Audio Extractor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet"></noscript>
  <style>
    :root {
      --bg-deep: #1a1625;
      --bg-panel: #201c2a;
      --bg-card: #282336;
      --bg-hover: #322c42;
      --border: #3a3450;
      --text: #f0ecf8;
      --text-muted: #a898c0;
      --text-dim: #786890;
      --accent: #ff7eb3;
      --accent-dim: rgba(255, 126, 179, 0.15);
      --accent-secondary: #7c5cff;
      --ue-blue: #00d4ff;
      --ue-dim: rgba(0, 212, 255, 0.12);
      --warning: #ffcc70;
      --error: #ff7b7b;
      --success: #7dffb3;
      --font-mono: 'JetBrains Mono', ui-monospace, 'Cascadia Code', monospace;
      --font-sans: 'Nunito', system-ui, -apple-system, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: var(--font-sans); background: var(--bg-deep); color: var(--text); display: flex; flex-direction: column; }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .header {
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      padding: 8px 12px;
      display: flex; align-items: center; gap: 12px;
      flex-shrink: 0;
    }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-icon {
      width: 32px; height: 32px;
      background: var(--ue-blue); border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; color: var(--bg-deep);
    }
    .logo h1 { font-size: 18px; font-weight: 700; letter-spacing: -0.3px; }
    .logo h1 .ue { color: var(--ue-blue); }
    .logo .subtitle {
      color: var(--text-dim); font-size: 11px; font-weight: 600;
      margin-left: 6px; background: var(--bg-card); padding: 2px 8px;
      border-radius: 10px; border: 1px solid var(--border);
    }
    .header-actions { margin-left: auto; display: flex; gap: 6px; }

    /* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
    .main { flex: 1; display: flex; overflow: hidden; }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar {
      width: 380px; min-width: 260px; background: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column; flex-shrink: 0;
    }
    .sidebar-toolbar {
      padding: 6px; border-bottom: 1px solid var(--border);
      display: flex; flex-direction: column; gap: 4px;
    }
    .sidebar-toolbar-row {
      display: flex; align-items: center; gap: 6px;
    }
    .file-count {
      margin-left: auto; font-family: var(--font-mono); font-size: 11px;
      color: var(--ue-blue); padding: 2px 8px; border-radius: 10px;
      background: var(--ue-dim); font-weight: 600;
    }
    .filter-pills { display: flex; gap: 2px; flex-wrap: wrap; }
    .filter-pill {
      font-family: var(--font-sans); font-size: 11px; font-weight: 600;
      padding: 3px 8px; border-radius: 6px; cursor: pointer;
      background: transparent; color: var(--text-dim);
      border: 1px solid transparent; transition: background 0.1s, color 0.1s;
    }
    .filter-pill:hover { background: var(--bg-hover); color: var(--text-muted); }
    .filter-pill.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }
    .filter-pill .pill-count {
      font-family: var(--font-mono); font-size: 10px;
      color: var(--text-dim); margin-left: 2px;
    }
    .filter-pill.active .pill-count { color: var(--accent); }

    /* ‚îÄ‚îÄ Tree ‚îÄ‚îÄ */
    .tree-container { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 2px 0; }
    .tree-container::-webkit-scrollbar { width: 6px; }
    .tree-container::-webkit-scrollbar-track { background: transparent; }
    .tree-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .tree-item {
      display: flex; align-items: center;
      padding: 3px 4px; cursor: pointer;
      gap: 4px; font-size: 12px;
      border-radius: 3px; margin: 0 2px;
      transition: background 0.1s;
    }
    .tree-item:hover { background: var(--bg-hover); }
    .tree-item.active { background: var(--accent-dim); color: var(--accent); }
    .tree-item.filtered-out { display: none; }
    .tree-item .icon { width: 14px; font-size: 11px; flex-shrink: 0; text-align: center; }
    .tree-item .name {
      flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .tree-item .type-badge {
      font-family: var(--font-mono); font-size: 8px; font-weight: 600;
      padding: 1px 4px; border-radius: 3px; flex-shrink: 0;
      color: var(--text-dim); background: var(--bg-card);
    }
    .tree-item .type-badge.tb-audio { color: var(--ue-blue); background: var(--ue-dim); }
    .tree-item .type-badge.tb-dlg { color: var(--success); background: rgba(125,255,179,0.1); }
    .tree-item .type-badge.tb-wem { color: var(--warning); background: rgba(255,204,112,0.1); }

    .tree-folder { margin: 0; }
    .tree-folder-header {
      display: flex; align-items: center;
      padding: 3px 4px; cursor: pointer;
      gap: 3px; font-size: 12px; font-weight: 600;
      margin: 0 2px; border-radius: 3px;
      color: var(--text-muted);
      transition: background 0.1s;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .tree-folder-header:hover { background: var(--bg-hover); }
    .tree-folder-header .chevron {
      width: 12px; font-size: 8px; color: var(--text-dim);
      transition: transform 0.15s;
    }
    .tree-folder-header.collapsed .chevron { transform: rotate(-90deg); }
    .tree-folder-children { padding-left: 8px; }
    .tree-folder-children.hidden { display: none; }
    .tree-folder.filtered-out { display: none; }

    /* ‚îÄ‚îÄ Content area ‚îÄ‚îÄ */
    .content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

    /* ‚îÄ‚îÄ Dropzone ‚îÄ‚îÄ */
    .dropzone-wrapper { padding: 12px; flex-shrink: 0; }
    .dropzone-wrapper.collapsed { padding: 6px 12px; }
    .dropzone {
      border: 2px dashed var(--border); border-radius: 12px;
      padding: 40px 24px; text-align: center; cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      background: var(--bg-card);
    }
    .dropzone:hover { border-color: var(--accent); }
    .dropzone.dragover { border-color: var(--ue-blue); background: var(--ue-dim); }
    .dropzone h3 { font-size: 17px; font-weight: 700; margin-bottom: 6px; }
    .dropzone-icon { font-size: 36px; margin-bottom: 10px; display: block; }
    .dropzone p { color: var(--text-muted); font-size: 13px; }
    .dropzone .hint {
      margin-top: 12px; font-family: var(--font-mono); font-size: 11px;
      color: var(--text-dim); background: var(--bg-panel); padding: 6px 12px;
      border-radius: 6px; display: inline-block; border: 1px solid var(--border);
    }
    .dropzone-mini {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 12px; border-radius: 8px;
      border: 1px dashed var(--border); cursor: pointer;
      font-size: 12px; color: var(--text-dim);
      transition: border-color 0.15s;
    }
    .dropzone-mini:hover { border-color: var(--accent); color: var(--text-muted); }

    .progress-bar {
      height: 4px; background: var(--bg-card); border-radius: 4px;
      overflow: hidden; margin: 8px 0;
    }
    .progress-bar .fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, var(--ue-blue), var(--accent));
      transition: width 0.15s;
    }
    .loading {
      display: flex; align-items: center; gap: 10px;
      padding: 8px 0; color: var(--text-muted); font-size: 13px; font-weight: 600;
    }
    .spinner {
      width: 16px; height: 16px;
      border: 2px solid var(--border); border-top-color: var(--ue-blue);
      border-radius: 50%; animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Detail panel ‚îÄ‚îÄ */
    .detail-panel {
      flex: 1; overflow-y: auto; padding: 12px;
    }
    .detail-panel::-webkit-scrollbar { width: 6px; }
    .detail-panel::-webkit-scrollbar-track { background: transparent; }
    .detail-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .detail-empty {
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      height: 100%; text-align: center; color: var(--text-dim);
    }
    .detail-empty .de-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }
    .detail-empty p { font-size: 14px; }

    .detail-header { margin-bottom: 12px; }
    .detail-name { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
    .detail-path { font-family: var(--font-mono); font-size: 11px; color: var(--text-dim); margin-bottom: 8px; word-break: break-all; }
    .detail-tags { display: flex; gap: 6px; flex-wrap: wrap; }

    .detail-section {
      background: var(--bg-card); border: 1px solid var(--border);
      border-radius: 8px; padding: 10px; margin-bottom: 8px;
    }
    .detail-section-title {
      font-size: 11px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.5px; color: var(--text-dim); margin-bottom: 8px;
    }

    .track-row {
      display: flex; flex-direction: column; gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    .track-row:last-child { border-bottom: none; padding-bottom: 0; }
    .track-row:first-child { padding-top: 0; }
    .track-meta { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
    .track-player { width: 100%; }
    .track-player audio { width: 100%; height: 32px; border-radius: 6px; outline: none; }
    .track-player audio::-webkit-media-controls-panel { background: var(--bg-hover); }
    .track-actions { display: flex; gap: 6px; }
    .wwise-notice {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 10px; background: rgba(255,204,112,0.06);
      border: 1px solid rgba(255,204,112,0.2); border-radius: 6px;
      color: var(--warning); font-size: 12px;
    }

    .dialogue-lines {
      max-height: 240px; overflow-y: auto;
      background: var(--bg-hover); border-radius: 6px;
      padding: 8px 10px; border: 1px solid var(--border);
    }
    .dialogue-lines::-webkit-scrollbar { width: 5px; }
    .dialogue-lines::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .dialogue-line {
      padding: 4px 0; font-size: 13px; line-height: 1.5;
      color: var(--text-muted); border-bottom: 1px solid rgba(58,52,80,0.5);
    }
    .dialogue-line:last-child { border-bottom: none; }

    .meta-tag {
      font-family: var(--font-mono); font-size: 10px; font-weight: 600;
      padding: 2px 6px; border-radius: 4px;
      color: var(--text-dim); background: var(--bg-hover); border: 1px solid var(--border);
    }
    .meta-tag.type-ogg { color: var(--ue-blue); background: var(--ue-dim); border-color: rgba(0,212,255,0.2); }
    .meta-tag.type-wav { color: var(--warning); background: rgba(255,204,112,0.1); border-color: rgba(255,204,112,0.2); }
    .meta-tag.type-wem { color: var(--error); background: rgba(255,123,123,0.08); border-color: rgba(255,123,123,0.2); }
    .meta-tag.type-dlg { color: var(--success); background: rgba(125,255,179,0.08); border-color: rgba(125,255,179,0.2); }

    /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
    .btn {
      display: inline-flex; align-items: center; gap: 4px;
      padding: 6px 10px; border-radius: 6px;
      font-family: var(--font-sans); font-size: 12px; font-weight: 600;
      cursor: pointer; border: 1px solid transparent;
      transition: background 0.1s, border-color 0.1s;
    }
    .btn-primary { background: var(--accent); color: var(--bg-deep); }
    .btn-primary:hover { background: #ff5c9a; }
    .btn-secondary { background: var(--bg-hover); color: var(--text); border-color: var(--border); }
    .btn-secondary:hover { background: var(--bg-card); border-color: var(--text-dim); }
    .btn-ghost { background: transparent; color: var(--text-muted); }
    .btn-ghost:hover { background: var(--bg-hover); color: var(--text); }
    .btn:disabled { opacity: 0.35; cursor: not-allowed; }

    /* ‚îÄ‚îÄ Stats bar ‚îÄ‚îÄ */
    .stats-bar {
      display: flex; gap: 16px; padding: 8px 12px;
      background: var(--bg-card); border-radius: 8px;
      margin-bottom: 8px; border: 1px solid var(--border); flex-wrap: wrap;
    }
    .stat { display: flex; align-items: center; gap: 6px; }
    .stat-value { font-family: var(--font-mono); font-weight: 700; color: var(--ue-blue); font-size: 14px; }
    .stat-label { color: var(--text-dim); font-size: 12px; }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 900px) { .sidebar { width: 300px; } }
    @media (max-width: 600px) {
      .main { flex-direction: column; }
      .sidebar { width: 100%; max-height: 40vh; border-right: none; border-bottom: 1px solid var(--border); }
    }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
    }
    .hidden-input { display: none; }
  </style>
</head>
<body>

<header class="header">
  <div class="logo">
    <div class="logo-icon">üéµ</div>
    <h1><span class="ue">ue</span><span class="xtract">xtract</span></h1>
    <span class="subtitle">browser-only</span>
  </div>
  <div class="header-actions">
    <button id="downloadAllOggBtn" class="btn btn-secondary" disabled><span>üì•</span> All OGG</button>
    <button id="downloadAllWavBtn" class="btn btn-secondary" disabled><span>üì•</span> All WAV</button>
    <button id="resetBtn" class="btn btn-ghost" disabled><span>üîÑ</span> Reset</button>
  </div>
</header>

<main class="main">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-toolbar" id="sidebarToolbar">
      <div class="sidebar-toolbar-row">
        <span style="font-size:13px;font-weight:700;color:var(--text-muted)">Files</span>
        <span class="file-count" id="fileCount">0</span>
      </div>
      <div class="filter-pills" id="filterPills" style="display:none">
        <button class="filter-pill active" data-filter="all">All</button>
        <button class="filter-pill" data-filter="audio">Audio <span class="pill-count" id="cntAudio">0</span></button>
        <button class="filter-pill" data-filter="dialogue">Dialogue <span class="pill-count" id="cntDlg">0</span></button>
        <button class="filter-pill" data-filter="wwise">Wwise <span class="pill-count" id="cntWwise">0</span></button>
        <button class="filter-pill" data-filter="data">Other <span class="pill-count" id="cntData">0</span></button>
      </div>
    </div>
    <div class="tree-container" id="treeContainer">
      <div class="detail-empty" style="padding:30px 16px">
        <div class="de-icon">üéÆ</div><p>Drop files to browse</p>
      </div>
    </div>
  </aside>

  <section class="content" id="contentArea">
    <div class="dropzone-wrapper" id="dropzoneWrapper">
      <div id="dropzone" class="dropzone">
        <span class="dropzone-icon">üì¶</span>
        <h3>Drop your Unreal assets here</h3>
        <p>Drag folders or .uasset / .uexp / .ubulk files</p>
        <div class="hint">OGG/WAV ¬∑ Wwise WEM ¬∑ DlgSystem dialogue ¬∑ .ubulk</div>
        <input id="fileInput" type="file" class="hidden-input" webkitdirectory multiple />
      </div>
      <div class="progress-bar" id="progressBar" style="display:none"><div class="fill" id="progressFill"></div></div>
      <div id="statusText" class="loading" style="display:none"><div class="spinner"></div><span>Processing...</span></div>
    </div>
    <div class="detail-panel" id="detailPanel" style="display:none"></div>
  </section>
</main>

<script>
// ============================================================
// uextract ‚Äì Lazy UE Audio Extractor
// ============================================================

const $ = id => document.getElementById(id);
const dropzone = $('dropzone');
const fileInput = $('fileInput');
const treeContainer = $('treeContainer');
const fileCountEl = $('fileCount');
// progressBar, progressFill, statusText are looked up live (they get recreated by resetUI / processFiles)
const dropzoneWrapper = $('dropzoneWrapper');
const detailPanel = $('detailPanel');
const filterPills = $('filterPills');
const downloadAllOggBtn = $('downloadAllOggBtn');
const downloadAllWavBtn = $('downloadAllWavBtn');
const resetBtn = $('resetBtn');

// Signatures
const SIG_OGG  = [0x4F,0x67,0x67,0x53];
const SIG_RIFF = [0x52,0x49,0x46,0x46];
const SIG_FMT  = [0x66,0x6D,0x74,0x20];
const SIG_DATA = [0x64,0x61,0x74,0x61];

const FMT_PCM = 0x0001, FMT_ADPCM = 0x0002, FMT_EXT = 0xFFFE, FMT_VORBIS = 0xFFFF;
const FMT_LABEL = { [FMT_PCM]:'PCM', [FMT_ADPCM]:'ADPCM', [FMT_EXT]:'Wwise PCM', [FMT_VORBIS]:'Wwise Vorbis' };

// State
let allAssets = [];
let fileTree = {};
let selectedAsset = null;
let currentFilter = 'all';
let activeBlobUrl = null;   // only one at a time (lazy)
let treeItemEls = [];       // for filtering

// Perf
let lastPT = 0;
function yieldToMain() { return new Promise(r => setTimeout(r, 0)); }
function throttleProg(p) {
  const n = performance.now();
  if (n - lastPT > 40 || p >= 99.9) { const el = $('progressFill'); if (el) el.style.width = p + '%'; lastPT = n; }
}

// ============================================================
// Events
// ============================================================
dropzone.addEventListener('click', () => fileInput.click());
dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('dragover'); });
dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
dropzone.addEventListener('drop', handleDrop);
fileInput.addEventListener('change', e => processFiles(e.target.files));
resetBtn.addEventListener('click', resetUI);
downloadAllOggBtn.addEventListener('click', () => downloadAllAudio('ogg'));
downloadAllWavBtn.addEventListener('click', () => downloadAllAudio('wav'));

filterPills.addEventListener('click', e => {
  const pill = e.target.closest('.filter-pill');
  if (!pill) return;
  filterPills.querySelector('.active')?.classList.remove('active');
  pill.classList.add('active');
  currentFilter = pill.dataset.filter;
  applyFilter();
});

async function handleDrop(e) {
  e.preventDefault();
  const dz = $('dropzone');
  if (dz) dz.classList.remove('dragover');
  const items = e.dataTransfer.items; const files = [];
  if (items) {
    const entries = [];
    for (const it of items) { const en = it.webkitGetAsEntry?.(); if (en) entries.push(en); }
    if (entries.length) {
      // Show immediate feedback on the dropzone itself
      if (dz) { dz.innerHTML = '<div class="spinner"></div><h3>Scanning folder\u2026</h3><p>0 files found</p>'; }
      showStatus('Scanning\u2026');
      await yieldToMain();                       // let the browser paint before heavy I/O
      for (const en of entries) await walkTree(en, files);
      if (dz) { const p = dz.querySelector('p'); if (p) p.textContent = files.length.toLocaleString() + ' files found'; }
      showStatus('Scanned ' + files.length.toLocaleString() + ' files \u2013 loading\u2026');
      await yieldToMain();
    }
  }
  if (files.length > 0) await processFiles(files);
  else if (e.dataTransfer.files.length > 0) await processFiles(e.dataTransfer.files);
}

async function walkTree(entry, files, path = '') {
  if (entry.isFile) {
    const f = await new Promise(r => entry.file(r));
    f.relativePath = path + f.name; files.push(f);
    // Yield every 200 files so the browser can repaint the counter
    if (files.length % 200 === 0) {
      const cnt = files.length.toLocaleString();
      showStatus('Scanning\u2026 ' + cnt + ' files found');
      const dz = $('dropzone'); if (dz) { const p = dz.querySelector('p'); if (p) p.textContent = cnt + ' files found'; }
      await yieldToMain();
    }
  } else if (entry.isDirectory) {
    const reader = entry.createReader();
    const all = await new Promise(res => {
      const a = []; const read = () => reader.readEntries(b => { if (!b.length) res(a); else { a.push(...b); read(); } }); read();
    });
    for (const c of all) await walkTree(c, files, path + entry.name + '/');
  }
}

// ============================================================
// Processing (lightweight ‚Äì no Blob creation)
// ============================================================
async function processFiles(fileList) {
  if (!fileList || !fileList.length) return;
  resetUI(); showProgress(0); showStatus('Reading files...');

  const files = Array.from(fileList);
  const assets = files.filter(f => { const n = f.name.toLowerCase(); return n.endsWith('.uasset') || n.endsWith('.uexp') || n.endsWith('.ubulk'); });
  if (!assets.length) { showStatus('No .uasset / .uexp / .ubulk files found'); setTimeout(hideStatus, 2000); hideProgress(); return; }

  showStatus('Reading ' + assets.length.toLocaleString() + ' asset files\u2026');
  fileCountEl.textContent = assets.length;
  resetBtn.disabled = false;

  // Read in parallel batches
  const B = 40, fileData = [];
  for (let i = 0; i < assets.length; i += B) {
    const sl = assets.slice(i, i + B);
    const res = await Promise.all(sl.map(async f => ({ file: f, buffer: await f.arrayBuffer(), path: f.relativePath || f.webkitRelativePath || f.name })));
    fileData.push(...res);
    throttleProg((i + sl.length) / assets.length * 40);
    if (i + B < assets.length) await yieldToMain();
  }

  showStatus('Grouping...');
  const packages = groupPackages(fileData);
  await yieldToMain();

  // Lightweight scan (metadata + audio descriptors, NO Blobs)
  showStatus('Scanning...');
  allAssets = [];
  const pkgs = Object.values(packages);
  for (let i = 0; i < pkgs.length; i += B) {
    const sl = pkgs.slice(i, i + B);
    for (const pkg of sl) { const r = scanPackage(pkg); if (r) allAssets.push(r); }
    throttleProg(40 + Math.min(i + B, pkgs.length) / pkgs.length * 60);
    if (i + B < pkgs.length) await yieldToMain();
  }

  hideProgress(); hideStatus();

  // Collapse dropzone, show tree
  dropzoneWrapper.classList.add('collapsed');
  dropzoneWrapper.innerHTML =
    '<div class="dropzone-mini" id="dropzoneMini">üì¶ Drop more files or click to add' +
    '<input id="fileInput2" type="file" class="hidden-input" webkitdirectory multiple /></div>' +
    '<div class="progress-bar" id="progressBar" style="display:none"><div class="fill" id="progressFill"></div></div>' +
    '<div id="statusText" class="loading" style="display:none"><div class="spinner"></div><span></span></div>';
  $('dropzoneMini').addEventListener('click', () => $('fileInput2').click());
  $('fileInput2').addEventListener('change', e => processFiles(e.target.files));

  // Update filter counts
  const counts = { audio: 0, dialogue: 0, wwise: 0, data: 0 };
  for (const a of allAssets) {
    const tags = assetTags(a);
    if (tags.has('audio')) counts.audio++;
    if (tags.has('dialogue')) counts.dialogue++;
    if (tags.has('wwise')) counts.wwise++;
    if (tags.has('data')) counts.data++;
  }
  $('cntAudio').textContent = counts.audio;
  $('cntDlg').textContent = counts.dialogue;
  $('cntWwise').textContent = counts.wwise;
  $('cntData').textContent = counts.data;
  filterPills.style.display = '';

  const hasPlayable = counts.audio > 0;
  downloadAllOggBtn.disabled = !hasPlayable;
  downloadAllWavBtn.disabled = !hasPlayable;

  // Build & render flat file tree
  buildFileTree(packages);
  renderFileTree();

  // Show detail-empty
  showDetailEmpty();
}

function groupPackages(data) {
  const pkgs = {};
  for (const { file, buffer, path } of data) {
    const m = file.name.match(/^(.+)\.(uasset|uexp|ubulk)$/i);
    if (!m) continue;
    const base = m[1], ext = m[2].toLowerCase(), dir = path.replace(/[^\/\\]*$/, ''), key = dir + base;
    if (!pkgs[key]) pkgs[key] = { name: base, path: dir, fullPath: key, files: {} };
    pkgs[key].files[ext] = { file, buffer };
  }
  return pkgs;
}

// ============================================================
// Lightweight scan ‚Äì only metadata + audio descriptors
// ============================================================
function scanPackage(pkg) {
  const { name, path, files, fullPath } = pkg;
  let meta = { type: 'Unknown', assetName: name, format: null };
  let isDlg = false;
  if (files.uasset) {
    meta = parseUAssetMeta(files.uasset.buffer);
    meta.assetName = meta.assetName || name;
    isDlg = meta.type.startsWith('Dlg') || meta.type === 'DialogueWave';
  }
  const tracks = [];
  if (files.uexp)  scanAudio(new Uint8Array(files.uexp.buffer), tracks, 'uexp');
  if (files.ubulk) scanAudio(new Uint8Array(files.ubulk.buffer), tracks, 'ubulk');

  const dlgLines = (isDlg && files.uexp) ? extractDlgText(new Uint8Array(files.uexp.buffer)) : [];

  return { name, path, fullPath, meta, tracks, dlgLines, _files: files };
}

function scanAudio(bytes, out, src) {
  // OGG
  const oo = findSig(bytes, SIG_OGG, 0);
  if (oo !== -1) {
    out.push({ type:'ogg', format:'OGG Vorbis', code:0, ch:null, sr:null, bps:0, playable:true, src, off:oo, end:bytes.length });
  }
  // RIFF
  let sf = 0;
  while (sf < bytes.length - 12) {
    const ro = findSig(bytes, SIG_RIFF, sf);
    if (ro === -1) break;
    if (bytes[ro+8]!==0x57||bytes[ro+9]!==0x41||bytes[ro+10]!==0x56||bytes[ro+11]!==0x45) { sf=ro+4; continue; }
    const rv = new DataView(bytes.buffer, bytes.byteOffset+ro);
    const rSz = rv.getUint32(4,true);
    const rEnd = Math.min(bytes.length, ro+rSz+8);
    const fmtO = findSig(bytes, SIG_FMT, ro+12);
    if (fmtO===-1||fmtO>=rEnd) { sf=ro+4; continue; }
    const fv = new DataView(bytes.buffer, bytes.byteOffset+fmtO);
    const af=fv.getUint16(8,true), ch=fv.getUint16(10,true), sr=fv.getUint32(12,true), bps=fv.getUint16(22,true);
    const label = FMT_LABEL[af]||('0x'+af.toString(16));
    const playable = af===FMT_PCM||af===FMT_EXT;
    const tp = (af===FMT_VORBIS||af===FMT_ADPCM) ? 'wem' : 'wav';
    out.push({ type:tp, format:label, code:af, ch, sr, bps, playable, src, off:ro, end:rEnd });
    sf = rEnd;
  }
}

// ============================================================
// Lazy Blob materialisation (only on user click)
// ============================================================
function materializeBlob(asset, track) {
  const fd = asset._files[track.src];
  if (!fd) return null;
  const bytes = new Uint8Array(fd.buffer);
  const slice = bytes.slice(track.off, track.end);

  if (track.code === FMT_EXT) {
    // Wwise PCM ‚Üí standard WAV
    return convertWwisePcm(slice, track.ch, track.sr, track.bps);
  }
  const mime = track.type==='ogg'?'audio/ogg': track.type==='wav'?'audio/wav':'application/octet-stream';
  return new Blob([slice], { type: mime });
}

function convertWwisePcm(riffBytes, ch, sr, bps) {
  const dOff = findSig(riffBytes, SIG_DATA, 0);
  if (dOff===-1) return null;
  const dv = new DataView(riffBytes.buffer, riffBytes.byteOffset+dOff);
  const dSz = dv.getUint32(4,true);
  const pcm = riffBytes.slice(dOff+8, Math.min(riffBytes.length, dOff+8+dSz));
  if (!bps) bps=16;
  const ba=ch*(bps>>3), br=sr*ba;
  const buf = new ArrayBuffer(44+pcm.length), v = new DataView(buf);
  wStr(v,0,'RIFF'); v.setUint32(4,36+pcm.length,true); wStr(v,8,'WAVE'); wStr(v,12,'fmt ');
  v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,ch,true);
  v.setUint32(24,sr,true); v.setUint32(28,br,true); v.setUint16(32,ba,true); v.setUint16(34,bps,true);
  wStr(v,36,'data'); v.setUint32(40,pcm.length,true);
  new Uint8Array(buf,44).set(pcm);
  return new Blob([buf],{type:'audio/wav'});
}

// ============================================================
// Asset tags (for filtering)
// ============================================================
function assetTags(a) {
  const t = new Set();
  if (a.tracks.some(x=>x.playable)) t.add('audio');
  if (a.dlgLines.length) t.add('dialogue');
  if (a.tracks.some(x=>!x.playable)) t.add('wwise');
  if (!t.size) t.add('data');
  return t;
}

function primaryTag(a) {
  if (a.tracks.some(x=>x.playable)) return 'audio';
  if (a.dlgLines.length) return 'dialogue';
  if (a.tracks.some(x=>!x.playable)) return 'wwise';
  return 'data';
}

// ============================================================
// File Tree
// ============================================================
function buildFileTree(pkgs) {
  fileTree = { name:'root', children:{}, type:'folder' };
  for (const [,pkg] of Object.entries(pkgs)) {
    const parts = pkg.path.split(/[\/\\]/).filter(Boolean);
    let cur = fileTree;
    for (const p of parts) {
      if (!cur.children[p]) cur.children[p] = { name:p, children:{}, type:'folder' };
      cur = cur.children[p];
    }
    cur.children[pkg.name] = { name:pkg.name, type:'file', pkg };
  }
}

function renderFileTree() {
  treeItemEls = [];
  const frag = document.createDocumentFragment();
  renderNode(fileTree, frag, 0);
  treeContainer.innerHTML = '';
  treeContainer.appendChild(frag);
  applyFilter();
}

function renderNode(node, container, depth) {
  if (node.type === 'folder' && node.name !== 'root') {
    const div = document.createElement('div');
    div.className = 'tree-folder';
    const hdr = document.createElement('div');
    hdr.className = 'tree-folder-header';
    hdr.style.paddingLeft = (depth*6+4)+'px';
    hdr.innerHTML = '<span class="chevron">‚ñº</span> <span>üìÅ</span> ' + esc(node.name);
    const kids = document.createElement('div');
    kids.className = 'tree-folder-children';
    hdr.addEventListener('click', () => { hdr.classList.toggle('collapsed'); kids.classList.toggle('hidden'); });
    div.appendChild(hdr); div.appendChild(kids); container.appendChild(div);
    div._folderKidsEl = kids;
    const sorted = Object.values(node.children).sort((a,b) => { if (a.type!==b.type) return a.type==='folder'?-1:1; return a.name.localeCompare(b.name); });
    for (const c of sorted) renderNode(c, kids, depth+1);
  } else if (node.type === 'file') {
    const asset = allAssets.find(a => a.fullPath === node.pkg?.fullPath);
    if (!asset) return;
    const tag = primaryTag(asset);
    const icons = { audio:'üîä', dialogue:'üí¨', wwise:'üî∂', data:'üìÑ' };
    const badgeCls = { audio:'tb-audio', dialogue:'tb-dlg', wwise:'tb-wem', data:'' };
    const item = document.createElement('div');
    item.className = 'tree-item';
    item.style.paddingLeft = ((depth+1)*6+4)+'px';
    item.innerHTML = '<span class="icon">' + (icons[tag]||'üìÑ') + '</span>' +
      '<span class="name" title="'+esc(node.name)+'">' + esc(node.name) + '</span>' +
      '<span class="type-badge ' + (badgeCls[tag]||'') + '">' + tag + '</span>';
    item._asset = asset;
    item._tags = assetTags(asset);
    item.addEventListener('click', () => selectAsset(asset, item));
    container.appendChild(item);
    treeItemEls.push(item);
  } else if (node.name === 'root') {
    const sorted = Object.values(node.children).sort((a,b) => { if (a.type!==b.type) return a.type==='folder'?-1:1; return a.name.localeCompare(b.name); });
    for (const c of sorted) renderNode(c, container, depth);
  }
}

function applyFilter() {
  for (const el of treeItemEls) {
    const show = currentFilter === 'all' || el._tags.has(currentFilter);
    el.classList.toggle('filtered-out', !show);
  }
  // Hide empty folders ‚Äì process bottom-up so inner empties are hidden before parents check
  const folders = Array.from(treeContainer.querySelectorAll('.tree-folder')).reverse();
  for (const folder of folders) {
    const kids = folder.querySelector('.tree-folder-children');
    if (!kids) { folder.classList.add('filtered-out'); continue; }
    const hasVisible = kids.querySelector('.tree-item:not(.filtered-out), .tree-folder:not(.filtered-out)');
    folder.classList.toggle('filtered-out', !hasVisible);
  }
}

// ============================================================
// Detail Panel (lazy render on click)
// ============================================================
function selectAsset(asset, treeEl) {
  // Highlight in tree
  treeContainer.querySelectorAll('.tree-item.active').forEach(e => e.classList.remove('active'));
  if (treeEl) treeEl.classList.add('active');
  selectedAsset = asset;

  // Free previous blob
  if (activeBlobUrl) { URL.revokeObjectURL(activeBlobUrl); activeBlobUrl = null; }

  detailPanel.style.display = '';
  detailPanel.scrollTop = 0;

  const tags = assetTags(asset);
  let tagHtml = '';
  for (const t of tags) {
    const cls = { audio:'type-ogg', dialogue:'type-dlg', wwise:'type-wem', data:'' }[t] || '';
    tagHtml += '<span class="meta-tag ' + cls + '">' + t + '</span>';
  }

  let html = '<div class="detail-header">' +
    '<div class="detail-name">' + esc(asset.name) + '</div>' +
    '<div class="detail-path">' + esc(asset.path || '/') + '</div>' +
    '<div class="detail-tags">' + tagHtml +
      '<span class="meta-tag">' + esc(asset.meta.type) + '</span>' +
    '</div></div>';

  // Stats
  html += '<div class="stats-bar">' +
    (asset.tracks.length ? '<div class="stat"><span class="stat-value">' + asset.tracks.length + '</span><span class="stat-label">tracks</span></div>' : '') +
    (asset.dlgLines.length ? '<div class="stat"><span class="stat-value">' + asset.dlgLines.length + '</span><span class="stat-label">lines</span></div>' : '') +
    '<div class="stat"><span class="stat-value">' + (asset._files.uasset?'‚úì':'‚Äî') + '</span><span class="stat-label">.uasset</span></div>' +
    '<div class="stat"><span class="stat-value">' + (asset._files.uexp?'‚úì':'‚Äî') + '</span><span class="stat-label">.uexp</span></div>' +
    '<div class="stat"><span class="stat-value">' + (asset._files.ubulk?'‚úì':'‚Äî') + '</span><span class="stat-label">.ubulk</span></div>' +
    '</div>';

  // Audio tracks
  if (asset.tracks.length) {
    html += '<div class="detail-section"><div class="detail-section-title">Audio Tracks</div>';
    asset.tracks.forEach((tr, i) => {
      const sizeKB = ((tr.end - tr.off) / 1024).toFixed(1);
      const tcls = tr.type==='ogg'?'type-ogg':tr.type==='wav'?'type-wav':'type-wem';
      html += '<div class="track-row" data-track="'+i+'">' +
        '<div class="track-meta">' +
          '<span class="meta-tag '+tcls+'">'+esc(tr.format)+'</span>' +
          '<span class="meta-tag">'+sizeKB+' KB</span>' +
          (tr.ch ? '<span class="meta-tag">'+tr.ch+'ch</span>' : '') +
          (tr.sr ? '<span class="meta-tag">'+tr.sr+' Hz</span>' : '') +
        '</div>';
      if (tr.playable) {
        html += '<div class="track-player" id="tp'+i+'"></div>' +
          '<div class="track-actions">' +
            '<button class="btn btn-primary play-btn" data-idx="'+i+'">‚ñ∂ Play</button>' +
            '<button class="btn btn-secondary dl-btn" data-idx="'+i+'" data-ext="'+(tr.type==='ogg'?'.ogg':'.wav')+'">üíæ '+(tr.type==='ogg'?'OGG':'WAV')+'</button>' +
            '<button class="btn btn-secondary dlwav-btn" data-idx="'+i+'">üíæ WAV</button>' +
          '</div>';
      } else {
        html += '<div class="wwise-notice">‚ö†Ô∏è '+esc(tr.format)+' ‚Äî download as .wem, convert with vgmstream / ww2ogg</div>' +
          '<div class="track-actions"><button class="btn btn-secondary dl-btn" data-idx="'+i+'" data-ext=".wem">üíæ WEM</button></div>';
      }
      html += '</div>';
    });
    html += '</div>';
  }

  // Dialogue
  if (asset.dlgLines.length) {
    html += '<div class="detail-section"><div class="detail-section-title">Dialogue</div>' +
      '<div class="dialogue-lines">' + asset.dlgLines.map(l => '<div class="dialogue-line">'+esc(l)+'</div>').join('') + '</div>' +
      '<div style="margin-top:6px"><button class="btn btn-secondary copy-dlg-btn">üìã Copy All</button></div>' +
      '</div>';
  }

  detailPanel.innerHTML = html;

  // Wire up events via delegation
  detailPanel.addEventListener('click', onDetailClick);
}

function onDetailClick(e) {
  const btn = e.target.closest('button');
  if (!btn || !selectedAsset) return;

  if (btn.classList.contains('play-btn')) {
    const idx = +btn.dataset.idx;
    const tr = selectedAsset.tracks[idx];
    const container = $('tp' + idx);
    if (!container) return;

    // Lazy: create audio element on first play
    if (!container.querySelector('audio')) {
      const blob = materializeBlob(selectedAsset, tr);
      if (!blob) return;
      if (activeBlobUrl) URL.revokeObjectURL(activeBlobUrl);
      activeBlobUrl = URL.createObjectURL(blob);
      container.innerHTML = '<audio controls autoplay style="width:100%;height:32px;border-radius:6px;outline:none" src="'+activeBlobUrl+'"></audio>';
      btn.textContent = '‚è∏ Pause';
    } else {
      const audio = container.querySelector('audio');
      if (audio.paused) { audio.play(); btn.textContent = '‚è∏ Pause'; }
      else { audio.pause(); btn.textContent = '‚ñ∂ Play'; }
    }
  }

  else if (btn.classList.contains('dl-btn')) {
    const idx = +btn.dataset.idx;
    const ext = btn.dataset.ext;
    const tr = selectedAsset.tracks[idx];
    const blob = materializeBlob(selectedAsset, tr);
    if (blob) downloadBlob(selectedAsset.name, blob, ext, idx);
  }

  else if (btn.classList.contains('dlwav-btn')) {
    const idx = +btn.dataset.idx;
    const tr = selectedAsset.tracks[idx];
    handleWavDl(btn, selectedAsset.name, selectedAsset, tr, idx);
  }

  else if (btn.classList.contains('copy-dlg-btn')) {
    navigator.clipboard.writeText(selectedAsset.dlgLines.join('\n\n'));
    btn.textContent = '‚úì Copied!';
    setTimeout(() => { btn.textContent = 'üìã Copy All'; }, 1200);
  }
}

function showDetailEmpty() {
  detailPanel.style.display = '';
  detailPanel.innerHTML = '<div class="detail-empty"><div class="de-icon">üëà</div><p>Select a file from the tree to preview</p></div>';
}

// ============================================================
// Downloads
// ============================================================
function downloadBlob(name, blob, ext, idx) {
  const fn = sanitize(name) + (idx > 0 ? '_'+(idx+1) : '') + ext;
  const a = document.createElement('a');
  const u = URL.createObjectURL(blob);
  a.href = u; a.download = fn; a.click();
  URL.revokeObjectURL(u);
}

async function handleWavDl(btn, name, asset, track, idx) {
  btn.disabled = true; btn.innerHTML = '<span class="spinner" style="width:12px;height:12px;border-width:2px"></span>';
  try {
    const blob = materializeBlob(asset, track);
    if (!blob) throw new Error('No data');
    if (track.type === 'wav') { downloadBlob(name, blob, '.wav', idx); }
    else {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const ab = await blob.arrayBuffer();
      const dec = await ctx.decodeAudioData(ab);
      downloadBlob(name, abToWav(dec), '.wav', idx);
      ctx.close();
    }
  } catch (err) { console.error(err); alert('WAV conversion failed.'); }
  btn.disabled = false; btn.textContent = 'üíæ WAV';
}

function abToWav(ab) {
  const nCh=ab.numberOfChannels, sr=ab.sampleRate, len=ab.length*nCh;
  const smp = new Float32Array(len);
  for (let c=0;c<nCh;c++){const d=ab.getChannelData(c);for(let i=0;i<ab.length;i++)smp[i*nCh+c]=d[i];}
  const buf=new ArrayBuffer(44+len*2), v=new DataView(buf), ba=nCh*2;
  wStr(v,0,'RIFF');v.setUint32(4,36+len*2,true);wStr(v,8,'WAVE');wStr(v,12,'fmt ');
  v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,nCh,true);
  v.setUint32(24,sr,true);v.setUint32(28,sr*ba,true);v.setUint16(32,ba,true);v.setUint16(34,16,true);
  wStr(v,36,'data');v.setUint32(40,len*2,true);
  let o=44;for(let i=0;i<len;i++){const s=Math.max(-1,Math.min(1,smp[i]));v.setInt16(o,s<0?s*0x8000:s*0x7FFF,true);o+=2;}
  return new Blob([buf],{type:'audio/wav'});
}

async function downloadAllAudio(fmt) {
  const btn = fmt==='ogg'?downloadAllOggBtn:downloadAllWavBtn;
  const orig = btn.innerHTML; btn.disabled = true;
  const tracks = [];
  for (const a of allAssets) for (let i=0;i<a.tracks.length;i++) if (a.tracks[i].playable) tracks.push({asset:a, track:a.tracks[i], idx:i});
  for (let i=0;i<tracks.length;i++) {
    btn.innerHTML = '<span class="spinner" style="width:12px;height:12px;border-width:2px"></span> '+(i+1)+'/'+tracks.length;
    const t=tracks[i], blob=materializeBlob(t.asset, t.track);
    if (!blob) continue;
    if (fmt==='wav') { try{await handleWavDl(btn,t.asset.name,t.asset,t.track,t.idx);}catch(e){} }
    else downloadBlob(t.asset.name, blob, t.track.type==='ogg'?'.ogg':'.wav', t.idx);
    await new Promise(r=>setTimeout(r,fmt==='wav'?80:120));
  }
  btn.disabled=false; btn.innerHTML=orig;
}

// ============================================================
// Metadata / Helpers
// ============================================================
function parseUAssetMeta(buf) {
  const text = extractStr(new Uint8Array(buf));
  const m = { type:'Unknown', assetName:null, format:null };
  const tm = [['SoundWave','SoundWave'],['SoundCue','SoundCue'],['DialogueWave','DialogueWave'],
    ['DialogueVoice','DialogueVoice'],['SoundClass','SoundClass'],['SoundMix','SoundMix'],
    ['SoundAttenuation','Attenuation'],['SoundConcurrency','Concurrency'],
    ['AkAudioEvent','Wwise Event'],['AkMediaAsset','Wwise Media'],
    ['DlgDialogue','DlgDialogue'],['DlgNode_Speech','DlgDialogue']];
  for (const [k,t] of tm) if (text.includes(k)){m.type=t;break;}
  if (/OGG\d+/.test(text)) m.format='OGG';
  if (/WAV|PCM/i.test(text)) m.format='WAV';
  const pm=text.match(/\/Game\/[^\/]+\/[^\x00]+/);
  if (pm) m.assetName=pm[0].split('/').pop().replace(/\x00/g,'');
  return m;
}

function extractStr(bytes, ml=4) {
  const p=[]; let c='';
  for (let i=0;i<bytes.length;i++){const b=bytes[i];if(b>=32&&b<127)c+=String.fromCharCode(b);else{if(c.length>=ml)p.push(c);c='';}}
  if(c.length>=ml)p.push(c); return p.join('\n');
}

function extractDlgText(bytes) {
  const lines=[], seen=new Set(); let cur='';
  for(let i=0;i<bytes.length;i++){const c=bytes[i];if(c>=32&&c<127)cur+=String.fromCharCode(c);else if((c===0x0D||c===0x0A)&&cur.length)cur+='\n';else{if(cur.length>=10){const t=cur.trim();if(t.length>=10&&!t.startsWith('{')&&!/^[0-9A-Fa-f]{32}$/.test(t)&&!/^Next$/m.test(t)&&t!=='None'&&!seen.has(t)){seen.add(t);lines.push(t);}}cur='';}}
  if(cur.length>=10){const t=cur.trim();if(t.length>=10&&!t.startsWith('{')&&!/^[0-9A-Fa-f]{32}$/.test(t)&&!seen.has(t)){seen.add(t);lines.push(t);}}
  return lines;
}

function findSig(b,s,f){const l=s.length,e=b.length-l;for(let i=f;i<=e;i++)if(b[i]===s[0]&&b[i+1]===s[1]&&b[i+2]===s[2]&&b[i+3]===s[3])return i;return-1;}
function wStr(v,o,s){for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));}
function esc(s){return s?s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])):''}
function sanitize(n){return n.replace(/[^a-zA-Z0-9_\-\.]/g,'_').slice(0,100)||'audio';}

// ============================================================
// UI helpers
// ============================================================
function showProgress(p){const b=$('progressBar'),f=$('progressFill');if(b)b.style.display='';if(f){f.style.width=p+'%';}lastPT=performance.now();}
function hideProgress(){const b=$('progressBar'),f=$('progressFill');if(b)b.style.display='none';if(f)f.style.width='0%';}
function showStatus(t){const s=$('statusText');if(s){s.style.display='flex';const sp=s.querySelector('span');if(sp)sp.textContent=t;}}
function hideStatus(){const s=$('statusText');if(s)s.style.display='none';}

function resetUI() {
  if (activeBlobUrl) { URL.revokeObjectURL(activeBlobUrl); activeBlobUrl=null; }
  allAssets=[]; fileTree={}; selectedAsset=null; currentFilter='all'; treeItemEls=[];
  detailPanel.style.display='none'; detailPanel.innerHTML='';
  // Restore dropzone
  dropzoneWrapper.classList.remove('collapsed');
  dropzoneWrapper.innerHTML =
    '<div id="dropzone" class="dropzone">' +
      '<span class="dropzone-icon">üì¶</span>' +
      '<h3>Drop your Unreal assets here</h3>' +
      '<p>Drag folders or .uasset / .uexp / .ubulk files</p>' +
      '<div class="hint">OGG/WAV ¬∑ Wwise WEM ¬∑ DlgSystem dialogue ¬∑ .ubulk</div>' +
      '<input id="fileInput" type="file" class="hidden-input" webkitdirectory multiple />' +
    '</div>' +
    '<div class="progress-bar" id="progressBar" style="display:none"><div class="fill" id="progressFill"></div></div>' +
    '<div id="statusText" class="loading" style="display:none"><div class="spinner"></div><span>Processing...</span></div>';
  // Rebind
  const dz = $('dropzone'), fi = $('fileInput');
  dz.addEventListener('click', () => fi.click());
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
  dz.addEventListener('drop', handleDrop);
  fi.addEventListener('change', e => processFiles(e.target.files));

  treeContainer.innerHTML = '<div class="detail-empty" style="padding:30px 16px"><div class="de-icon">üéÆ</div><p>Drop files to browse</p></div>';
  fileCountEl.textContent = '0';
  filterPills.style.display = 'none';
  filterPills.querySelector('.active')?.classList.remove('active');
  filterPills.querySelector('[data-filter="all"]').classList.add('active');
  downloadAllOggBtn.disabled=true; downloadAllWavBtn.disabled=true; resetBtn.disabled=true;
  hideProgress(); hideStatus();
}
</script>
</body>
</html>
